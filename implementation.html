<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Simple Event Example</title>
      <script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>


      <style type="text/css">
      body{
        font-family: sans-serif;;
      }
      circle.selected{
        fill:#3eb489;
      }
      circle{
        fill:black;
      }
      p{
        margin:0;
      }
#setVars{
  float: left;
  background-color: #ededed;
  border-radius: 10px;
  padding: 15px;
  margin-right:75px;
  margin-left: 50px;
  margin-top:0;
  margin-bottom: 50px;
}
#setVars p{
  text-align: center;
  line-height: 5%;
}
#visDiv{
  float: left;
}
#controls{
  float:left;
}
#info{
  position:absolute;
  width:200px;
  height:auto;
  padding:10px;
  background-color:white;
  border-radius:10px;
  box-shadow: 4px 4px 10px rgba(0,0,0,0.4);
}
#info.hidden{
  display:none;
}
#info p{
  margin:0px;
  font-family:sans-serif;
  font-size:12px;
}

</style>
  </head>
  <body> <!-- Contains title, variable selection, vis and tooltop -->
    <div id="title">
      <h1>RadViz Implementation</h1>
      <!--<h3 style="text-align:center">Multivariate Exploration of US Census Data</h3>-->
    </div>

    Enter csv url: <input type="text" id="inputURL" value="http://www.cs.middlebury.edu/~candrews/classes/infovis/data/green500_top_201511.csv">
    <button type="button" onclick="loadData()">Load Data!</button>


    <form action="setTooltipDisplay" id="setTooltipDisplay">
      <p style="margin-bottom:10px"> <b>Show in Tooltip:</b> </p>
          <table>
       <tr>
          <td id="tooltip"></td>
       </tr>
    </table>
    </form>


    <form action="setVariables" id="setVars">
      <p style="margin-bottom:10px"> <b>Select Variables</b> </p>
          <table>
       <tr>
          <td id="numeric"></td>
       </tr>
    </table>
    </form>

    <div id="visDiv">
    </div>


<div id="info" class="hidden">
  <g id="nonNumeric"></g>
  <g id="numeric"></g>
</div>

<!--
<p id="name">Name</p>
<p><span id="variable1">Variable X</span>: <span id="value1">Value 1</span></p>
<p><span id="variable2">Variable Y</span>: <span id="value2">Value 2</span></p>-->

    <script>
      var createVis = function(parent, width, height){
        var dataset, displayVars, springConstants, anchorPoints, tooltipVars;
        //var variables = [];

        var margins = {top:20, bottom:60, left: 60, right:20};
        var chartWidth = width - margins.left - margins.right;
        var chartHeight = height - margins.top - margins.bottom;
        var center = {x: chartWidth/2, y: chartHeight/2};
        var radius = Math.min(center.x, center.y);


        var svg = d3.select(parent)
          .append("svg")
          .attr({width:width, height:height});

        var chart = svg.append("g")
          .attr("transform", "translate("+margins.left + "," + margins.top + ")");

        var chartBorder = svg.append("g")
          .attr("transform", "translate("+margins.left + "," + margins.top + ")")

        var angleToPoint = function(angle) {
          return {
            x: center.x + radius*Math.cos(angle),
            y: center.y + radius*Math.sin(angle)
          };
        };

        var vis = function(){
          console.log("displayVars:"); console.log(displayVars);
          console.log("tooltipvars:"); console.log(tooltipVars)
          // xScale.domain(d3.extent(dataset, function(d){return +d[xData];}));
          // yScale.domain(d3.extent(dataset, function(d){return +d[yData];}));
          anchorPoints = displayVars.map(function(d, i, arr){return angleToPoint((2*Math.PI/arr.length)*i);});

          var anchorCircles = chartBorder.selectAll("circle").data(anchorPoints);
          anchorCircles.exit().remove();
          anchorCircles.enter().append("circle");
          anchorCircles
          // .transition()  //THESE *ALMOST* WORK. i think we need a finer selection as to not select the border circle
          // .duration(500) //TODO: FIX THEM
          .attr({
            cx: function(d){return d.x},
            cy: function(d){return d.y},
            r: 3
          }).style("fill", "black");  //TODO: somehow color coordinate these?


          chartBorder.append("circle")
          .attr({
            cx: center.x,
            cy: center.y,
            r: radius,
            })
            .style("stroke", "black")    // set the line color
            .style("fill", "none");

          springConstants = displayVars.map(function(){return d3.scale.linear().range([0, 1]);});
          springConstants.forEach(function(element, index, array){
            element.domain(d3.extent(dataset, function(d){return +d[displayVars[index]];}));
          });

          var circles = chart.selectAll("circle").data(dataset);

          circles.exit().remove();

          circles.enter().append("circle");

          var getPt = function(d) {
            var list = springConstants.map(function(element, index, array){
              return element(d[displayVars[index]]);}
              );
            var sum = list.reduce(function(prev, cur) {return prev + cur;});
            var pt = {x:0, y:0};
            for (var i = 0; i < anchorPoints.length; i++) {
              pt.x += (list[i]/sum)*anchorPoints[i].x
              pt.y += (list[i]/sum)*anchorPoints[i].y
            }
            return pt;
          }

          var getX = function(d) {return getPt(d).x; };

          var getY = function(d) {return getPt(d).y; };

          circles.transition()
          .duration(500)
          .attr({
            cx: getX,
            cy: getY,
            r: 2
          });

          circles.on("mouseover", function(d){
            d3.select(this)
              .classed("selected", true)
              .attr("r", 8);

            var info = d3.select("#info");

            var nonNumeric = info.select("#nonNumeric").selectAll("p").data(tooltipVars);
            nonNumeric.exit().remove();
            nonNumeric.enter().append("p");
            nonNumeric.text(function(varName){return varName + ": " + d[varName]});

            var numeric = info.select("#numeric").selectAll("p").data(displayVars);
            numeric.exit().remove();
            numeric.enter().append("p");
            numeric.text(function(varName){return varName + ": " + d[varName]});

            var coordinates = d3.mouse(svg.node());
            var bbox = svg.node().getBoundingClientRect();
            coordinates[0] += bbox.left;
            coordinates[1] += bbox.top;

            info.style({
              left: (coordinates[0] + 25) + "px",
              top: (coordinates[1] ) + "px",
            })
            .classed("hidden", false);

          })
          .on("mouseout", function(d){
            d3.select(this)
              .classed("selected", false)
              .attr("r", 2);

              var info = d3.select("#info");
              info.classed("hidden", true);
          });

        };


        vis.loadData = function(data){
          dataset = data;
          return vis;
        }

        vis.setVars = function(value){
          if (!arguments.length) return displayVars;
          displayVars = value;
          return vis;
        }

        vis.setTooltipVars = function(value) {
          if (!arguments.length) return tooltipVars;
          tooltipVars = value;
          return vis;
        }

        return vis;
      };

      var vis = createVis("#visDiv", 400,400);
      var loadData = function() {
        url = document.getElementById("inputURL").value;
        console.log(url);

        d3.csv(url,
          function(dataset){ if(!dataset) {alert("Invalid data"); return;}

            //copied from: http://stackoverflow.com/questions/18082/validate-decimal-numbers-in-javascript-isnumeric
            var isNumeric = function( n ) {
              return !isNaN(parseFloat(n)) && isFinite(n);
            }

            var addToTable = function(propertyList, parent, name) {

              var inputlist = d3.select(parent).selectAll("g").data(propertyList);

              inputlist.exit().remove();

              var groups = inputlist.enter().append("g");
              groups.append("input");
              groups.append("text");

              inputlist.select("input")
              .attr({
                "type":"checkbox",
                "value":function(d){return d},
                "label":function(d){return d},
                "name":name
              });

              inputlist.select("text").text(function(d){return d}).append("p");
            };

            var numericProps = [];
            for (property in dataset[0]) {
              if (isNumeric(dataset[0][property])) {
                numericProps.push(property);
              }
            }
            addToTable(numericProps, "#numeric", "numericAttribute");

            //adding all data attributes to tooltip table
            addToTable(Object.keys(dataset[0]), "#tooltip", "tooltipAttribute");

            vis.loadData(dataset);
            vis.setVars([]);
            vis.setTooltipVars([]);
            vis();
        });

        // Allow for user to adjust displayed variables and redraws vis as changes occur.
        var numericAttributeSelection = d3.select("#setVars").on("change", function(d){
          var selection = document.querySelectorAll('input[name="numericAttribute"]:checked');
          var variables = [];
          for (var i=0; i<selection.length; i++) {
            variables.push(selection[i].value);
          }
          //console.log(variables);
          vis.setVars(variables);
          vis();
        });

        //TODO: REFACTOR THIS AND ABOVE INTO ONE GENERAL FUNCTION
        var tooltipAttributeSelection = d3.select("#setTooltipDisplay").on("change", function(d){
          var selection = document.querySelectorAll('input[name="tooltipAttribute"]:checked');
          var variables = [];
          for (var i=0; i<selection.length; i++) {
            variables.push(selection[i].value);
          }

          vis.setTooltipVars(variables);
          vis();
        });
      }



//TODO:
  // Tooltip!!! :D :P
    // HTML checkbox to sync data with tooltip
  // Color by:
    // have generate color key
    //10 == cutoff for categorical data (use category(10))
    //HTML input form with checks for any dimensions with less than 10 different results
    //None also an option
  // Make the page pretty


//TODO:
  //presentation_materials
    // spring metaphor: Ben add picture
    //



    </script>
  </body>
</html>
